<template>
  <div class="myhome">
    <div class="home-item" v-for="(item,i) in homeLists">
      <img :src="getBaseUrl + item.SmallImgUrl" alt="" class="item-image">
      <!--<div class="item-image" :style="{'background-image':'url('+(item.SmallImgUrl?getBaseUrl + item.SmallImgUrl:'')+')','background-size':'cover'}"></div>-->
      <div class="item-des">
        <div class="tittle">{{item.RName}}</div>
        <div class="text">共{{item.MatchCount}}场赛事，已有{{item.OrderCount}}人报名</div>
        <div class="btns">
          <div class="introduce" @click="introduce(item)">路线介绍</div>
          <div class="choice" @click="signUp(item)">我要报名</div>
        </div>
      </div>
    </div>
    <div class="kong">

    </div>
    <houseToast ref="toast"></houseToast>
  </div>
</template>
<script>
import { mapGetters, mapMutations, mapActions } from 'vuex';
import houseBtn from './common/house-btn.vue';
import houseHead from './common/house-head.vue';
import houseToast from './common/house-toast.vue';
import {util} from '../assets/js/util'
import wx from 'weixin-js-sdk'
export default{
  template: '.myhome',
  data: function () {
    return {
      errorMessage: '',
      isHide: true,
      titleShow: true,
      dywFinish: false,
      glrFinish: false,
      jkxqFinish: false,
      disabled: true,
      batchApplyId: '',
      homeLists:[]
    };
  },
  computed: {
    ...mapGetters([
      'getBaseUrl'
    ])
  },
  components: {
    houseHead,
    houseBtn,
    houseToast
  },
  methods: {
    getHomeList () { // 获取首页列表
      let data = {
        data:{},
        url:this.getBaseUrl + 'CommonHandler/RouteHandler.ashx?Action=routeshow'
      };
      util.fetchData (data).then(res => {
        if (res.data.result == 0) {
          console.log('data',res.data);
          this.homeLists = res.data.data;
        }
        else {

        }
      });
    },
    ...mapActions([
      'changeRoute',
      'changeOpenId',
      'changeUserInfo'
    ]),
    getJsdk () {
      let data = {
        data:{
          Action:'getweixinjsapiconfig',
          url:encodeURIComponent(location.href.split('#')[0])
        },
        url:this.getBaseUrl + 'CommonHandler/APIHandler.ashx'
      };
      util.fetchData (data).then(res => {
        console.log('jssdk',res.data.data);
        const _jsApiList = ["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","closeWindow","chooseImage","previewImage","uploadImage","downloadImage"];
        let config = res.data.data;
        config.debug = true;
        config.jsApiList = _jsApiList;
        wx.config(config);
        wx.ready(function(){
          $("#sharePage").click(function () {
            wx.onMenuShareAppMessage({
              title: '这是一个自定义的标题！', // 分享标题
              desc: '这是一个自定义的描述！', // 分享描述
              link: host + '/index.html', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
              imgUrl: host + '/wx_pic.png', // 分享图标
              type: 'link', // 分享类型,music、video或link，不填默认为link
              success: function () {
                // 用户确认分享后执行的回调函数
                alert('succ')
              },
              fail () {
                alert('分享失败')
              },
              complete () {
                alert('分享结束')
              },
              cancel: function () {
                // 用户取消分享后执行的回调函数
                alert('cancel')
              }
            });
            alert('已注册获取“发送给朋友”状态事件');
          });

        })
      });
    },
    getOpenId () { // 获取openid
      let data = {
        data:{
          Action:'getuserinfobycode',
          code:util.getQueryString('code') || ''
        },
        url:this.getBaseUrl + 'CommonHandler/APIHandler.ashx'
      };
      util.fetchData (data).then(res => {
      if (res.data.result == 0) {
        this.changeOpenId(res.data.data.openid); // 存储openid
        this.changeUserInfo(res.data.data); // 存储useinfo
        // this.$refs.toast.toastShow('额度预估成功，页面即将跳转!')
      }
      else {

      }
      });
    },
    init () {
      this.getHomeList();
      this.getOpenId();
      this.getJsdk();
      window.changeTitle('驯鹿户外');
    },
    introduce(item) {
      this.changeRoute(item);
      this.$router.push('/routerIntroduce');
    },
    signUp(item){
      this.changeRoute(item);
      this.$router.push('/activeLists');
    }
  },
  created () {

  },
  mounted () {
    this.init()
  }
};
</script>
<style lang="less">
  @import './../assets/less/myhome.less';
</style>
